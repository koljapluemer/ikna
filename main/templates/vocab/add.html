{% extends 'core/base.html' %}
{% block content %}
<div class="w-full max-w-xl" x-data="wordForm('{{ word.translation|default:"" }}')">
    <h1 class="text-2xl font-bold mb-4">
        {% if word %}Edit Word{% else %}Add New Word{% endif %}
    </h1>
    <form method="post" action="{% if word %}{% url 'vocab_edit' word.pk %}{% else %}{% url 'vocab_add' %}{% endif %}"
        class="space-y-4">
        {% csrf_token %}

        <div class="flex flex-col gap-1 items-start border-t-2 border-dotted border-gray-400 pt-2">
            <label class="">üá™üá¨</label>
            <input type="text" name="translation" x-model="translation" value="{{ word.translation|default:'' }}"
                class="input input-bordered w-full input-lg" placeholder="e.g. 'lAbAn'">


            <div class="p-2 input input-lg input-bordered w-full">
                <span x-text="converted" class="text-xl"></span>
            </div>

            <details class="bg-white dark:bg-slate-800 p-4 rounded shadow">
                <summary class="cursor-pointer text-xs">Type in Franco. Arabic script will be automatically generated.
                    Click here to see how the conversion works.</summary>
                <div class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                    <p class="mb-4">
                        This conversion uses a complete mapping from unique Latin keys to each Arabic
                        letter‚Äîincluding
                        all 4 short vowels. Multi-letter sequences are matched first, then single-letter keys.
                    </p>
                    <table class="table w-full">
                        <thead class="bg-slate-200 dark:bg-slate-600">
                            <tr>
                                <th class="p-2">Latin Key</th>
                                <th class="p-2">Arabic Character</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2">kh</td>
                                <td class="p-2">ÿÆ</td>
                            </tr>
                            <tr>
                                <td class="p-2">gh</td>
                                <td class="p-2">ÿ∫</td>
                            </tr>
                            <tr>
                                <td class="p-2">sh</td>
                                <td class="p-2">ÿ¥</td>
                            </tr>
                            <tr>
                                <td class="p-2">th</td>
                                <td class="p-2">ÿ´</td>
                            </tr>
                            <tr>
                                <td class="p-2">dh</td>
                                <td class="p-2">ÿ∞</td>
                            </tr>
                            <tr>
                                <td class="p-2">2</td>
                                <td class="p-2">ÿ°</td>
                            </tr>
                            <tr>
                                <td class="p-2">3</td>
                                <td class="p-2">ÿπ</td>
                            </tr>
                            <tr>
                                <td class="p-2">a</td>
                                <td class="p-2">ÿß</td>
                            </tr>
                            <tr>
                                <td class="p-2">b</td>
                                <td class="p-2">ÿ®</td>
                            </tr>
                            <tr>
                                <td class="p-2">t</td>
                                <td class="p-2">ÿ™</td>
                            </tr>
                            <tr>
                                <td class="p-2">g</td>
                                <td class="p-2">ÿ¨</td>
                            </tr>
                            <tr>
                                <td class="p-2">7</td>
                                <td class="p-2">ÿ≠</td>
                            </tr>
                            <tr>
                                <td class="p-2">d</td>
                                <td class="p-2">ÿØ</td>
                            </tr>
                            <tr>
                                <td class="p-2">r</td>
                                <td class="p-2">ÿ±</td>
                            </tr>
                            <tr>
                                <td class="p-2">z</td>
                                <td class="p-2">ÿ≤</td>
                            </tr>
                            <tr>
                                <td class="p-2">s</td>
                                <td class="p-2">ÿ≥</td>
                            </tr>
                            <tr>
                                <td class="p-2">S</td>
                                <td class="p-2">ÿµ</td>
                            </tr>
                            <tr>
                                <td class="p-2">D</td>
                                <td class="p-2">ÿ∂</td>
                            </tr>
                            <tr>
                                <td class="p-2">T</td>
                                <td class="p-2">ÿ∑</td>
                            </tr>
                            <tr>
                                <td class="p-2">Z</td>
                                <td class="p-2">ÿ∏</td>
                            </tr>
                            <tr>
                                <td class="p-2">f</td>
                                <td class="p-2">ŸÅ</td>
                            </tr>
                            <tr>
                                <td class="p-2">q</td>
                                <td class="p-2">ŸÇ</td>
                            </tr>
                            <tr>
                                <td class="p-2">k</td>
                                <td class="p-2">ŸÉ</td>
                            </tr>
                            <tr>
                                <td class="p-2">l</td>
                                <td class="p-2">ŸÑ</td>
                            </tr>
                            <tr>
                                <td class="p-2">m</td>
                                <td class="p-2">ŸÖ</td>
                            </tr>
                            <tr>
                                <td class="p-2">n</td>
                                <td class="p-2">ŸÜ</td>
                            </tr>
                            <tr>
                                <td class="p-2">h</td>
                                <td class="p-2">Ÿá</td>
                            </tr>
                            <tr>
                                <td class="p-2">w</td>
                                <td class="p-2">Ÿà</td>
                            </tr>
                            <tr>
                                <td class="p-2">y</td>
                                <td class="p-2">Ÿä</td>
                            </tr>
                            <tr>
                                <td class="p-2">A</td>
                                <td class="p-2">Ÿé</td>
                            </tr>
                            <tr>
                                <td class="p-2">U</td>
                                <td class="p-2">Ÿè</td>
                            </tr>
                            <tr>
                                <td class="p-2">I</td>
                                <td class="p-2">Ÿê</td>
                            </tr>
                            <tr>
                                <td class="p-2">O</td>
                                <td class="p-2">Ÿí</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>

            <textarea name="translation_info" class="textarea textarea-bordered w-full"
                placeholder="Extra info: plural, conjugation forms, ...">{{ word.translation_info|default:'' }}</textarea>


            <!-- Hidden field for Arabic script -->
            <input type="hidden" name="script" :value="converted">

            <div class="flex flex-col gap-1 items-start border-t-2 border-dotted border-gray-400 pt-2">
                <label class="">üá©üá™/üá¨üáß</label>
                <input type="text" name="native" value="{{ word.native|default:'' }}"
                    class="input input-bordered input-lg flex-1" placeholder="e.g. 'Milk'">
                <textarea name="native_info" class="textarea textarea-bordered w-full"
                    placeholder="Extra info: word form, usage context, ...">{{ word.native_info|default:'' }}</textarea>
            </div>


            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    {% if word %}Save Changes{% else %}Save Word{% endif %}
                </button>
            </div>

    </form>
</div>

<script>
    function wordForm(initialTranslation = '') {
        return {
            translation: initialTranslation,
            get converted() {
                return convertFrancoToArabic(this.translation);
            }
        }
    }
    function convertFrancoToArabic(text) {
        const mappings = [
            { key: "kh", value: "ÿÆ" },
            { key: "gh", value: "ÿ∫" },
            { key: "sh", value: "ÿ¥" },
            { key: "th", value: "ÿ´" },
            { key: "dh", value: "ÿ∞" },
            { key: "2", value: "ÿ°" },
            { key: "3", value: "ÿπ" },
            { key: "a", value: "ÿß" },
            { key: "b", value: "ÿ®" },
            { key: "t", value: "ÿ™" },
            { key: "g", value: "ÿ¨" },
            { key: "7", value: "ÿ≠" },
            { key: "d", value: "ÿØ" },
            { key: "r", value: "ÿ±" },
            { key: "z", value: "ÿ≤" },
            { key: "s", value: "ÿ≥" },
            { key: "S", value: "ÿµ" },
            { key: "D", value: "ÿ∂" },
            { key: "T", value: "ÿ∑" },
            { key: "Z", value: "ÿ∏" },
            { key: "f", value: "ŸÅ" },
            { key: "q", value: "ŸÇ" },
            { key: "k", value: "ŸÉ" },
            { key: "l", value: "ŸÑ" },
            { key: "m", value: "ŸÖ" },
            { key: "n", value: "ŸÜ" },
            { key: "h", value: "Ÿá" },
            { key: "w", value: "Ÿà" },
            { key: "y", value: "Ÿä" },
            { key: "A", value: "Ÿé" },
            { key: "U", value: "Ÿè" },
            { key: "I", value: "Ÿê" },
            { key: "O", value: "Ÿí" },
            { key: " ", value: " " }
        ];
        let result = '';
        let i = 0;
        while (i < text.length) {
            let matched = false;
            for (let len = 2; len > 0; len--) {
                if (i + len <= text.length) {
                    const substr = text.substring(i, i + len);
                    const mapping = mappings.find(m => m.key === substr);
                    if (mapping) {
                        result += mapping.value;
                        i += len;
                        matched = true;
                        break;
                    }
                }
            }
            if (!matched) { i++; }
        }
        return result;
    }
</script>
{% endblock %}